<!DOCTYPE html>
<meta charset="utf-8">
<style>
.node circle {
    fill: #999;
}

.node text {
    font: 10px sans-serif;
}

.node--internal circle {
    fill: #555;
}

.node--internal text {
    text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
}

.link {
    fill: none;
    stroke: #555;
    stroke-opacity: 0.4;
    stroke-width: 1.5px;
}
</style>
<svg width="1024" height="768"></svg>
<script src="//d3js.org/d3.v5.min.js"></script>
<script>
var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height"),
    g = svg.append("g").attr("transform", "translate(40,0)");

var link = g.selectAll(".link")
var node = g.selectAll(".node")
var label = g.selectAll(".label")

var date = svg.append('text')
    .text('date')
    .attr('x', 20)
    .attr('y', 30)

var tree = d3.cluster()
    .size([height, width - 250]);

var stratify = d3.stratify()
    .parentId(function(d) { return d.id.substring(0, d.id.lastIndexOf(".")); });

var ageColor = d3.scaleLinear()
    .range(['#E74C3C','#34495E'])
    .domain([0,1])

console.log(ageColor(0.5))

d3.tsv("toc-complete.csv").then(function(data) {

    data.forEach(d => {
        d.id = d.number;
    })

    data = d3.nest()
        .key(function(d) { return d.revid })
        .entries(data)

    console.log(data)

    data.forEach(d => {

        d.values.forEach(value => {
            value.number = '0.' + value.number
            value.id = '0.' + value.id
            value.age = 0;
        })

        let obj = {
            anchor: "root",
            byteoffset: "0",
            date: d.values[0].date,
            fromtitle: "Race_and_intelligence",
            id: "0",
            index: "0",
            level: "1",
            line: "Race and intelligence",
            number: "0",
            revid: d.values[0].revid,
            time: "16:10:01Z",
            toclevel: "0",
            age: 0
        }

        d.values.unshift(obj);


    })

    let counter = data.length;
    window.setInterval(function() {
        counter -= 1;

        if (counter >= 0) {

            update(data[counter].values);
        } else {
            counter = data.length;
        }

    }, 250);

    function update(data) {
        console.log(data[0].date);

        var root = stratify(data)
            .sort(function(a, b) { return (a.height - b.height) || a.id.localeCompare(b.id); });

        tree(root);

        let anim_duration = 50;

        date.text(data[0].date)

        link = link.data(root.descendants().slice(1))
        link.exit().remove()

        link = link.enter().append("path")
            .attr("class", "link")
            .merge(link)

        link.transition().duration(anim_duration)
            .attr("d", function(d) {
                return "M" + d.y + "," + d.x +
                    "C" + (d.parent.y + 100) + "," + d.x +
                    " " + (d.parent.y + 100) + "," + d.parent.x +
                    " " + d.parent.y + "," + d.parent.x;
            });

        node.each( function(d){
            let currentAge = d3.select(this).attr('age')*1;
            currentAge +=0.05;
            currentAge = d3.select(this).attr('age', currentAge)
        })

        node = node.data(root.descendants(), function(d) {
            return d.data.id + '-' + d.data.line
        })

        node.exit().remove()


        node = node.enter().append("circle")
            .attr("class", function(d) { return "node" + (d.children ? " node--internal" : " node--leaf"); })
            .attr('cx', function(d) { return d.y * 1.5 })
            .attr('cy', function(d) { return d.x })
            .attr('r', 5)
            .attr('age', 0)
            .merge(node)
            .attr('fill', function(d) {
                let currentAge = d3.select(this).attr('age')*1
                return ageColor(currentAge >= 1 ? 1 : currentAge)
            })

        node
            .transition().duration(anim_duration)
            .attr('cx', function(d) { return d.y })
            .attr('cy', function(d) { return d.x })

        label.each( function(d){
            let currentAge = d3.select(this).attr('age')*1;
            currentAge +=0.05;
            currentAge = d3.select(this).attr('age', currentAge)
        })

        label = label.data(root.descendants(), function(d) {
            return d.data.id + '-' + d.data.line
        })

        label.exit().remove()

        label = label.enter().append("text")
            .attr("class", function(d) { return "label" + (d.children ? " label--internal" : " label--leaf"); })
            .attr('x', function(d) { return d.y })
            .attr('y', function(d) { return d.x })
            .merge(label)
            .text(function(d) { return d.data.line })
            .attr('fill', function(d) {
                let currentAge = d3.select(this).attr('age')*1
                return ageColor(currentAge >= 1 ? 1 : currentAge)
            })
            

        label
            .transition().duration(anim_duration)
            .style('opacity', 1)
            .attr('y', function(d) { return d.x })
            .attr('x', function(d) { return d.y })

    }


});
</script>